detectors:
  slicing_aggr:
    gap_ms: 80
    k_min: 5
    qty_min: 1
    require_equal: true     # true=iceberg ; false=hitting
    equal_tol_pct: 0
    equal_tol_abs: 0

  slicing_hit:
    gap_ms: 80
    k_min: 1
    qty_min: 150.0          # hitting (no igualdad)
    # require_equal forzado a false en código

  slicing_pass:
    gap_ms: 120
    k_min: 6
    qty_min: 5.0
    require_equal: true
    equal_tol_pct: 0
    equal_tol_abs: 0

  absorption:
    dur_s: 10.0
    vol_btc: 450.0
    max_price_drift_ticks: 2
    tick_size: 0.1          # <- usado para convertir drift a ticks con ancla best

  break_wall:
    n_min: 3
    dep_pct: 0.40
    basis_vel_abs_bps_s: 1.5
    metric_source: legacy          # legacy|doc|auto (default legacy por seguridad)
    doc:
      window_s: 3.0                # debe alinear con metrics_doc depletion window
      dv_dep_warn: 20.0            # p95 recomendado (calibrable)
      dv_refill_max: 10.0          # máximo refill permitido (calibrable)
      clamp_abs_dv: 300.0
      require_negative: true       # para considerar depletion solo si dv<0
    require_depletion: true
    top_levels_gate: 20         # niveles top para gating
    tick_size: 0.1              # Binance BTCUSDT
    forbid_refill_under_pct: 0.6
    refill_window_s: 3.0
    refill_min_pct: 0.60        # si recupera <60% en 3s => no_refill (ok ruptura)

  dominance:
    enabled: true
    dom_pct: 0.80
    dom_pct_doc: 0.60       # umbral por volumen DOC
    metric_source: auto     # legacy|doc|auto
    max_spread_usd: 2.0
    levels: 1000             # puedes subir a 5000 si tu book/REST lo soporta
    hold_ms: 1000
    retrigger_s: 30

  # --- R11–R12 Spoofing (bid/ask). Usa stream de depth y trades para ratio ejecución/cancelación
  spoofing:
    enabled: true
    top_levels_gate: 30        # el muro debe aparecer en los primeros N niveles
    wall_size_btc: 80.0        # tamaño mínimo del muro
    distance_ticks: 10         # distancia máxima al best para calificar como “muro”
    appear_within_ms: 400      # muro aparece “de golpe”
    hold_min_ms: 500           # debe sostenerse un mínimo tiempo
    cancel_within_ms: 1200     # retirada rápida sospechosa
    min_exec_ratio: 0.05       # % ejecutado mínimo para NO ser spoof (si es menor => sospecha)
    max_cancel_ratio: 0.85     # % cancelado alto => sospecha
    per_side:
      bid:
        wall_size_btc: 80.0
      ask:
        wall_size_btc: 80.0

  # --- R13–R14 Depletion masivo (pérdida abrupta de liquidez por lado)
  depletion:
    enabled: true
    window_s: 2.0           # ventana de observación
    n_levels: 50            # niveles a evaluar
    pct_drop_bid: 0.35      # caída relativa en bid
    pct_drop_ask: 0.35      # caída relativa en ask
    pct_drop: 0.35          # compat: umbral global si no se usa pct_drop_{side}
    hold_ms: 800
    retrigger_s: 30
    metric_source: legacy   # legacy|doc|auto
    doc:
      window_s: 3               # debe coincidir con depletion_*_doc.window_s (metrics_doc)
      dv_warn: 10.0             # umbral mínimo en unidades de volumen (ej. BTC qty)
      dv_strong: 30.0           # umbral “fuerte” en mismas unidades
      clamp_abs_dv: 200.0       # seguridad outliers
      severity_mode: linear     # linear|log
      require_negative: true    # solo considerar depletion cuando dv < 0 (delta negativo)

  # --- R15–R18 Basis thresholds (Mark/Index). Leídos por las reglas, no depth.
  basis:
    metric_source: auto     # legacy|doc|auto
    doc_sign_mode: legacy   # legacy=invierte DOC para mantener semántica actual
    extreme:
      pos_bps: 100          # contango extremo -> R15
      neg_bps: -100         # backwardation extremo -> R16
    mean_revert:
      gate_abs_bps: 25
      vel_gate_abs: 1.5
      retrigger_s: 60

  # --- R19–R22 Opciones (Deribit). Umbrales de IV y Skew de OI
  options:
    iv_spike:
      window_s: 60
      up_pct: 15            # R19
      down_pct: -15         # R20
      surface: "ATM_30d"    # p. ej. IV de 30 días ATM
    oi_skew:
      min_calls: 100
      min_puts: 100
      bull_ratio: 1.5       # R21: calls/puts >= 1.5
      bear_ratio: 1.5       # R22: puts/calls >= 1.5
      
  tape_pressure:
    enabled: true
    window_s: 5.0           # ventana para acumular flujo agresivo
    min_trades: 10          # mínimo de trades en la ventana
    min_qty_btc: 30.0       # volumen total mínimo en la ventana
    ofi_up: 0.65            # (BUY_VOL - SELL_VOL) / (BUY_VOL + SELL_VOL) ≥ 0.65 -> R23
    ofi_down: -0.65         # ... ≤ -0.65 -> R24
    max_spread_usd: 2.0     # gating por spread
    hold_ms: 500            # evitar flicker, mantener la condición
    retrigger_s: 20         # cooldown para no spamear

  oi_spike:
    enabled: false
    poll_s: 5
    retrigger_s: 60
    oi_window_s: 120
    momentum_window_s: 60
    oi_warn_pct: 0.80
    oi_strong_pct: 1.50
    mom_warn_usd: 8.0
    mom_strong_usd: 20.0
    require_same_dir: true

  liq_cluster:
    enabled: false
    poll_s: 5
    window_s: 60
    retrigger_s: 90

    # Umbrales de cluster (preferir USD si existe quote_qty_usd)
    warn_usd: 1_000_000
    strong_usd: 3_000_000

    # Confirmación por precio (no-rebound)
    confirm_s: 10
    momentum_window_s: 30
    min_move_usd: 25.0
    max_rebound_usd: 10.0

    # Selección de métrica
    use_usd: true          # si quote_qty_usd no existe, usar qty
    clamp_usd: 50_000_000  # seguridad outliers

  top_traders:
    enabled: false
    poll_s: 15
    retrigger_s: 300
    # Umbrales para ACCOUNT ratio
    acc_warn: 0.60
    acc_strong: 0.70
    # Umbrales para POSITION ratio
    pos_warn: 0.60
    pos_strong: 0.70
    # Política de disparo
    require_both: false          # true => exige account y position a la vez
    choose_by: "max_score"       # max_score | account_only | position_only

  basis_dislocation:
    enabled: false
    poll_s: 10
    retrigger_s: 180

    metric_source: auto        # legacy|doc|auto
    # thresholds basis/vel (bps)
    basis_warn_bps: 60.0
    basis_strong_bps: 120.0
    vel_warn_bps_s: 1.0
    vel_strong_bps_s: 2.0

    # funding confirm (DOC)
    require_funding_confirm: true
    funding_window_s: 900              # 15m
    funding_trend_warn: 0.00001
    funding_trend_strong: 0.00003

    # policy
    allow_emit_without_funding: false  # si true, permite emitir con basis+vel aunque falte funding
    clamp_abs_basis_bps: 1000.0
    clamp_abs_vel_bps_s: 50.0

  skew_shock:
    enabled: false
    poll_s: 15
    retrigger_s: 300

    underlying: "BTC"
    window_s: 300
    # Umbrales de shock (unidades de rr_25d, típicamente “vol points” en decimal)
    delta_warn: 0.010
    delta_strong: 0.020
    vel_warn_per_s: 0.00003
    vel_strong_per_s: 0.00006

    clamp_abs_rr: 1.0
    clamp_abs_delta: 0.2
    clamp_abs_vel_per_s: 0.01

    require_recent_past: true

  gamma_flip:
    enabled: false
    poll_s: 30
    retrigger_s: 900

    underlying: "BTC"

    lookback_s: 600
    expiry_max_days: 45
    moneyness_abs: 0.10
    delta_gate_enabled: true
    delta_min: 0.35
    delta_max: 0.65

    min_instruments: 30
    min_abs_net_gex: 1.0e6
    flip_hysteresis: 0.10

    clamp_spot: [1000, 1000000]
    clamp_gamma: [0, 1e3]
    clamp_oi: [0, 1e9]

    intensity_warn: 1.0e6
    intensity_strong: 5.0e6

    require_stable_samples: 2
    min_oi: 0.0

  iv_spike:
    enabled: false
    poll_s: 30
    retrigger_s: 600
    underlying: "BTC"

    # fuente principal
    tenor_bucket: "0_7d"
    moneyness_bucket: "NA"

    lookback_s: 900
    window_s: 300                # delta IV entre now y now-window_s

    dv_warn: 0.03                # 3 vol points (si iv en decimales)
    dv_strong: 0.07
    vel_warn_per_s: 0.00010      # opcional
    vel_strong_per_s: 0.00025
    use_velocity_gate: false

    clamp_iv: [0.0, 5.0]
    clamp_dv: [-1.0, 1.0]
    clamp_vel: [-0.01, 0.01]

    require_positive_spike: true # true => solo IV sube; false => también shock a la baja

    # fallback
    fallback_to_ticker: true
    ticker_delta_gate_enabled: true
    ticker_delta_min: 0.35
    ticker_delta_max: 0.65
    ticker_expiry_max_days: 45
    ticker_moneyness_abs: 0.10
    ticker_min_instruments: 20

  term_structure_invert:
    enabled: false
    poll_s: 30
    retrigger_s: 600

    underlying: "BTC"
    lookback_s: 600
    short_tenor_bucket: "0_7d"
    long_tenor_bucket: "30_90d"
    moneyness_bucket: "NA"

    spread_warn: 0.05
    spread_strong: 0.10

    vel_warn_per_s: 0.0002
    vel_strong_per_s: 0.0004
    use_velocity_gate: false

    clamp_abs_iv: 5.0
    clamp_abs_spread: 1.0
    clamp_abs_vel_per_s: 0.01

    require_both_present: true
    require_positive_inversion: true

  spread_squeeze:
    enabled: true
    max_spread_usd: 0.5     # compresión del spread
    levels: 50              # head del libro para medir profundidad
    min_depth_bid_btc: 200.0
    min_depth_ask_btc: 200.0
    hold_ms: 1500           # mantener squeeze un tiempo
    retrigger_s: 30
    
  metrics:
    imbalance_buy: 0.65
    imbalance_sell: -0.65
    basis_vel_up: 2.5
    basis_vel_dn: -2.5
    basis_extreme_pos: 80.0
    basis_extreme_neg: -80.0
    spread_squeeze: 0.5
  metrics_doc:
    imbalance_doc_window_s: 3
    dominance_doc_window_s: 2
    depletion_doc_window_s: 3
    basis_doc_window_s: 120
    oi_doc_window_s: 120
